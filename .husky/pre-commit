# Store the repo root for later
REPO_ROOT=$(pwd)

# Frontend: Biome via lint-staged
cd frontend && npx lint-staged

# Backend: Ruff for staged Python files
cd "$REPO_ROOT/backend"

# Get staged Python files in backend
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^backend/.*\.py$' | sed 's|^backend/||')

if [ -n "$STAGED_PY_FILES" ]; then
  echo "üêç Running Ruff on staged Python files..."

  # Check if virtual environment exists
  if [ -d ".venv" ]; then
    source .venv/bin/activate
  elif [ -d "venv" ]; then
    source venv/bin/activate
  fi

  # Run ruff check with auto-fix, then format
  echo "$STAGED_PY_FILES" | xargs ruff check --fix --quiet
  echo "$STAGED_PY_FILES" | xargs ruff format --quiet

  # Re-stage the fixed files (go back to repo root for correct paths)
  cd "$REPO_ROOT"
  echo "$STAGED_PY_FILES" | xargs -I {} git add "backend/{}"
fi
